var hot,detailtable,count,clear,update,onchange,resize,sch=new schulze,data=[["","John","Joe","David","Mary"],["Project 1",90,60,80,70],["Project 2",80,50,70,60],["Project 3",70,40,60,50],["Project 4",60,"",50,40],["Project 5",50,20,"",30]],sample=[["","宜靜","技安","阿福","大雄","聰明","世修","叮噹"],["林崔馬克","95","87","78","50","73","85","80"],["亞洲模擬人權法院","80","75","76","58","80","75","40"],["實價登錄 2.0 & 臺灣公寓大廈資料庫","95","83","80","59","72","85","80"],["回音森林","83","78","76","73","80","80","48"],["好新聞連播網","83","78","76","85","86","75","72"],["反制中共網軍入侵中文維基百科","70","83","78","5","76","85","80"],["BBC 拍攝","70","81","78","3","82","75","56"],["Cofacts 真的假的","73","81","82","40","20","80","64"],["2020投票指南","72","88","72","4","87","75","80"],["誠徵一日資料申請小幫手 ^^","84","90","86","74","86","85","48"],["Rentea 設計給租屋者的開源找屋工具","81","78","72","60","72","80","40"],["立志收羅全球知識，機器看得懂的維基百科--Wikidata","72","78","70","76","71","85","48"],["全民一起參與2020 總統候選人事實查核","85","87","70","6","78","80","80"],["g0v 社群治理討論 ","73","81","74","2","72","85","48"],["違章工廠舉報系統","80","79","68","72","75","80","48"],["NT01 地球上的夢幻逸品線上型錄","74","83","76","10","77","85","48"],["台灣開源義肢計劃","72","81","78","1","78","75","72"],[" 選舉/金流百科","95","79","66","70","89","75","80"],["資料申請小幫手","70","79","64","3","73","75","40"],["農業災損幾多錢","70","85","78","30","87","75","72"],["大河小溪全民齊督工","90","81","80","61","76","80","48"],["開源找屋工具","87","89","88","80","91","75","48"]],local={},versusRenderer=function(e,t,n,r,o,a,c){var l;local.judges;return Handsontable.renderers.TextRenderer.apply(this,arguments),l=e.getDataAtCell(r-2,n+2),n+2===r||r<2?{}:(t.classList.remove("win","lose","tie"),l<a?t.classList.add("win"):a<l?t.classList.add("lose"):t.classList.add("tie"))};Handsontable.renderers.registerRenderer("versusRenderer",versusRenderer),hot=new Handsontable(document.querySelector("#grid .inner"),{data:data,rowHeaders:!0,colHeaders:!0,filters:!0,dropdownMenu:!0,afterChange:onchange,rowHeights:35,colWidths:80,modifyColWidth:function(e,t){if(0===t)return 300},stretchH:"all"}),Handsontable.hooks.add("beforePaste",function(){return clear()},hot),Handsontable.hooks.add("afterPaste",function(){return update()},hot),detailtable=new Handsontable(document.querySelector("#detail-grid .inner"),{rowHeaders:!0,colHeaders:!0,filters:!0,dropdownMenu:!0,rowHeights:30,colWidths:30,cells:function(e,t){return{renderer:"versusRenderer",readOnly:!0}},modifyColWidth:function(e,t){if(1===t)return 300},stretchH:"all"}),count={row:hot.countRows(),col:hot.countCols()},clear=function(){return data.splice(0),data.push([""]),hot.updateSettings({data:data,cells:function(e,t){return{readOnly:!1}}}),detailtable.updateSettings({data:[[""]]}),local={}},(update=function(){var e;return count.row=hot.countRows(),count.col=hot.countCols(),e=JSON.parse(JSON.stringify(data)),local.ranked&&(count.col--,e.map(function(e){return e.splice(e.length-1)})),local.judges=e[0].slice(1),sch.fromArray(e,{isRowBased:!1}).then(function(e){var r=e.candidates,e=e.pairPreferenceMatrix;return local.ranked=!0,hot.setDataAtCell(0,count.col,"Rank"),hot.updateSettings({cells:function(e,t){return t===count.col?{readOnly:!0}:{}}}),hot.setDataAtCell(function(){for(var e=[],t=0,n=r.length;t<n;++t)e.push(t);return e}().map(function(e){e=r[e];return[e.idx+1,count.col,e.rank]})),detailtable.loadData(e.byRank.map(function(e){return[e[0].rank,e[0].name].concat(e.slice(1))})),(e=800<(e=30*(count.row-1)+120)?e:800)<.75*window.innerWidth?e=.75*window.innerWidth:e>window.innerWidth&&(e=window.innerWidth),document.querySelector("#detail-grid").style.width=e+"px",detailtable.updateSettings({width:e})})})(),onchange=function(){return update()},resize=function(){var e,t,n=Array.from(document.querySelectorAll("input")).map(function(e){return+e.value}),r=n[0],o=n[1];if(!isNaN(o)&&1<o){if(o<count.row)for(e=count.row-1;o<=e;--e)t=e,hot.alter("remove_row",t);if(o>count.row)for(e=count.row;e<o;++e)t=e,hot.alter("insert_row",t);count.row=o}if(!isNaN(r)&&1<r){if(r<count.col)for(e=count.col-1;r<=e;--e)t=e,hot.alter("remove_col",t);if(r>count.col)for(e=count.col;e<r;++e)t=e,hot.alter("insert_col",t);count.col=r}return hot.updateSettings({cells:function(e,t){return e<count.row&&t<count.col?{readOnly:!1}:{readOnly:!0}}})},document.querySelector(".btn[data-action=clear]").addEventListener("click",function(){return clear()}),document.querySelector(".btn[data-action=sample]").addEventListener("click",function(){return clear(),data=JSON.parse(JSON.stringify(sample)),hot.updateSettings({data:data}),update()});